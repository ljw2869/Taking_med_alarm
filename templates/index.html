<div class="stats-container" style="display: flex; gap: 20px; margin-bottom: 20px;">
  <div class="stat-card" style="flex: 1; padding: 15px; background-color: #f0f8ff; border-radius: 10px; text-align: center;">
    <h3>ğŸ‘¥ ì „ì²´ ê³ ê°</h3>
    <p style="font-size: 24px; font-weight: bold;">{{ stats.total }}</p>
  </div>

  <div class="stat-card" style="flex: 1; padding: 15px; background-color: #fff0f5; border-radius: 10px; text-align: center;">
    <h3>â³ 7ì¼ ì´ë‚´ ì˜ˆì •</h3>
    <p style="font-size: 24px; font-weight: bold; color: #ff4500;">{{ stats.due_soon }}</p>
  </div>

  <div class="stat-card" style="flex: 1; padding: 15px; background-color: #e6ffe6; border-radius: 10px; text-align: center;">
    <h3>ğŸ“… ì˜¤ëŠ˜ ìˆ˜ë ¹</h3>
    <p style="font-size: 24px; font-weight: bold; color: #008000;">{{ stats.due_today }}</p>
  </div>

  <div class="stat-card" style="flex: 1; padding: 15px; background-color: #ffe4e1; border-radius: 10px; text-align: center;">
    <h3>âš ï¸ ìˆ˜ë ¹ ì§€ì—°</h3>
    <p style="font-size: 24px; font-weight: bold; color: #b22222;">{{ stats.overdue }}</p>
  </div>
</div>

<h2>ê³ ê° ì¶”ê°€</h2>
<form method="POST" action="/add_customer">
  ì´ë¦„: <input name="name" required> ì—°ë½ì²˜: <input name="contact">
  ì‹œì‘ì¼: <input type="date" name="start_date" required>
  ì²« ìˆ˜ë ¹ë¶„: <input type="number" input name="first_weeks" value="4" min="1" required> ì£¼
  <button type="submit">ê³ ê° ì¶”ê°€</button>
</form>



<h2>ê³ ê° ëª©ë¡</h2>
<ul>
  {% for customer in customers %}
    <li>
      <a href="/customer/{{ customer.id }}">
        {{ customer.name }}
      </a>
      <span style="color: '{% if customer.d_day > 0 %}green{% elif customer.d_day==0 %}black{% else %}red{% endif %}'; font-weight: bold;">
        {% if customer.d_day == 0 %}
          (ì˜¤ëŠ˜ ë³µìš©ì¼!)
        {% elif customer.d_day > 0 %}
          (D-{{ customer.d_day }})
        {% else %}
          (D+{{ customer.d_day | abs }})
        {% endif %}
      </span>
    </li>
  {% endfor %}
</ul>

<!-- ë¦¬ìŠ¤íŠ¸ ëë‚œ í›„ ê´€ë¦¬ ë²„íŠ¼ -->
<div style="margin-top:20px; text-align:center">
  <a href="{{ url_for('manage_customers') }}">
    <button type="button">ê³ ê° ê´€ë¦¬</button>
  </a>
</div>

<!-- ğŸ“Š í†µê³„ ìš”ì•½ ì„¹ì…˜ -->
<div class="dashboard">
  <h2>ğŸ“Š ë³µìš© í˜„í™© ìš”ì•½</h2>
  <div class="stats-container">
    <div class="stat-card">
      <h3>ì „ì²´ ê³ ê° ìˆ˜</h3>
      <p id="total_customers">-</p>
    </div>
    <div class="stat-card">
      <h3>ì„ë°• ì•Œë¦¼ ê³ ê°</h3>
      <p id="imminent_alerts">-</p>
    </div>
    <div class="stat-card">
      <h3>ê¸°í•œ ì´ˆê³¼ ê³ ê°</h3>
      <p id="overdue_customers">-</p>
    </div>
    <div class="stat-card">
      <h3>ì¶”ê°€ ìˆ˜ë ¹ ì£¼ì°¨ í•©ê³„</h3>
      <p id="total_extra_weeks">-</p>
    </div>
  </div>
</div>

<hr>

<!-- ğŸ“… ìº˜ë¦°ë” ì„¹ì…˜ -->
<h2>ğŸ“† ê³ ê°ë³„ ë‹¤ìŒ ìˆ˜ë ¹ ì¼ì •</h2>
<div id="calendar"></div>

<!-- âœ… Chart.js + FullCalendar.js ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
  fetch("/dashboard_data")
    .then(res => res.json())
    .then(data => {
      // ğŸ“Š í†µê³„ í‘œì‹œ
      document.getElementById("total_customers").textContent = data.total_customers;
      document.getElementById("imminent_alerts").textContent = data.imminent_alerts;
      document.getElementById("overdue_customers").textContent = data.overdue_customers;
      document.getElementById("total_extra_weeks").textContent = data.total_extra_weeks;

      // ğŸ“† FullCalendar í‘œì‹œ
      const events = data.customers
        .filter(c => c.next_due_date)
        .map(c => ({
          title: `${c.name} (D${c.d_day >= 0 ? "-" + c.d_day : "+" + Math.abs(c.d_day)})`,
          start: c.next_due_date,
          color: c.d_day < 0 ? "#ff6b6b" : (c.d_day <= 7 ? "#ffa502" : "#2ed573")
        }));

      const calendarEl = document.getElementById("calendar");
      const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: "dayGridMonth",
        events: events,
        height: "auto",
        eventClick: function(info) {
          const customerName = info.event.title.split(" (")[0];
          alert(`${customerName}ë‹˜ì˜ ë‹¤ìŒ ìˆ˜ë ¹ì¼: ${info.event.start.toISOString().split("T")[0]}`);
        }
      });
      calendar.render();
    });
});
</script>

<style>
.dashboard {
  margin: 30px 0;
}
.stats-container {
  display: flex;
  gap: 15px;
  flex-wrap: wrap;
}
.stat-card {
  flex: 1;
  min-width: 180px;
  background: #f7f9fc;
  border: 1px solid #e1e4e8;
  border-radius: 12px;
  padding: 16px;
  text-align: center;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.stat-card h3 {
  margin-bottom: 8px;
  font-size: 1.1rem;
  color: #333;
}
.stat-card p {
  font-size: 1.5rem;
  font-weight: bold;
  color: #007bff;
}
#calendar {
  margin-top: 20px;
}
</style>
